<div class="flex flex-col">
  <h1 class='bg-blue-200 m-auto text-5xl'>プラン作成</h1>
    <%= render 'form', plan: @plan %>
</div> 

<style>
  #map {
    height: 700px;
    width: 70%;
  }
</style>

 <script>
  let map
  let geocoder
  let markerPoint = [];

  function initMap(){
    geocoder = new google.maps.Geocoder()

    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 36.204824, lng: 138.252924}, // 日本の位置を初期値とする
      zoom: 2,
    });
  }

  function codeAddress(){
    let country_name
    let contry_latitude
    let country_longitude
    let inputAddress = document.getElementById('address').value;
    let add = document.getElementById('add');

    geocoder.geocode( { 'address': inputAddress}, function(results, status) {
      if (status == 'OK') {
        // map.setCenter(results[0].geometry.location); 取得したマーカーを中心にセットし直してしまうので、コメントアウト
        let marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });

        markerPoint.push(marker);
        country_name = results[ 0 ].formatted_address.split(/、|\s/, 1);
        country_latitude = results[ 0 ].geometry.location.lat();
        country_longitude = results[ 0 ].geometry.location.lng();
        // console.log(marker); marker の情報を取得するため

        add.outerHTML = `<a id="add" class="btn btn-secondary hover hover:link add_fields" data-association-insertion-node="#detail-association-insertion-point" data-association-insertion-method="append" data-association="country" data-associations="countries" data-association-insertion-template="<tr id='country_fields' class= 'nested-fields'>
        <td><input placeholder=&quot;country_name&quot; class=&quot;country_name py-2 px-3 text-gray-700 &quot; type=&quot;text&quot; name=&quot;plan[countries_attributes][new_countries][name]&quot; id=&quot;plan_countries_attributes_new_countries_name&quot; value=&quot;${country_name}&quot; />
        </td>
        <td class=&quot;hidden&quot;><input placeholder=&quot;latitude&quot; class=&quot;latitude py-2 px-3 text-gray-700 &quot; type=&quot;text&quot; name=&quot;plan[countries_attributes][new_countries][latitude]&quot; id=&quot;plan_countries_attributes_new_countries_latitude&quot; value=&quot;${country_latitude}&quot; />
        </td>
        <td class=&quot;hidden&quot;><input placeholder=&quot;longitude&quot; class=&quot;longitude py-2 px-3 text-gray-700&quot; type=&quot;text&quot; name=&quot;plan[countries_attributes][new_countries][longitude]&quot; id=&quot;plan_countries_attributes_new_countries_longitude&quot; value=&quot;${country_longitude}&quot; />
        </td>
        <td onclick=&quot;deleteMarker()&quot;><input value=&quot;false&quot; autocomplete=&quot;off&quot; type=&quot;hidden&quot; name=&quot;plan[countries_attributes][new_countries][_destroy]&quot; id=&quot;plan_countries_attributes_new_countries__destroy&quot; /><a class=&quot;remove_bty btn btn-danger link link-hover remove_fields dynamic&quot; href=&quot;#&quot;>remove</a>
        </td>
        </tr>
        " href="#">add</a>`;

      } else {
        alert('該当する結果がありませんでした：' + status);
      }
    });
  }

  function putCode(){
    let promise = new Promise((resolve) => {
     resolve(codeAddress());
    })
    .then(() => {
      setTimeout(() => {
        document.getElementById('add').click();
      },200);
    })
    .then(() => {
      setTimeout(() => {
        document.getElementById('address').value ='';
        document.getElementById('add').outerHTML = `<a id="add" class="btn btn-secondary hover hover:link add_fields" data-association-insertion-node="#detail-association-insertion-point" data-association-insertion-method="append" data-association="country" data-associations="countries" data-association-insertion-template="<tr id='country_fields' class= 'nested-fields'>
          <td><input placeholder=&quot;country_name&quot; class=&quot;country_name py-2 px-3 text-gray-700 &quot; type=&quot;text&quot; name=&quot;plan[countries_attributes][new_countries][name]&quot; id=&quot;plan_countries_attributes_new_countries_name&quot; value=&quot;&quot; />
          </td>
          <td><input placeholder=&quot;latitude&quot; class=&quot;latitude py-2 px-3 text-gray-700 &quot; type=&quot;text&quot; name=&quot;plan[countries_attributes][new_countries][latitude]&quot; id=&quot;plan_countries_attributes_new_countries_latitude&quot; value=&quot;&quot; />
          </td>
          <td><input placeholder=&quot;longitude&quot; class=&quot;longitude py-2 px-3 text-gray-700&quot; type=&quot;text&quot; name=&quot;plan[countries_attributes][new_countries][longitude]&quot; id=&quot;plan_countries_attributes_new_countries_longitude&quot; value=&quot;&quot; />
          </td>
          <td><input value=&quot;false&quot; autocomplete=&quot;off&quot; type=&quot;hidden&quot; name=&quot;plan[countries_attributes][new_countries][_destroy]&quot; id=&quot;plan_countries_attributes_new_countries__destroy&quot; /><a class=&quot;remove_bty btn btn-danger link link-hover remove_fields dynamic&quot; href=&quot;#&quot;>remove</a>
          </td>
          </tr>
          " href="#">add</a>`;
      },200)
    });
  }

  function deleteMarker(){

    let clickedElement = event.target;
    let latitude = clickedElement.parentNode.parentNode.children[1].firstElementChild.value;  // latitude
    let longitude = clickedElement.parentNode.parentNode.children[2].firstElementChild.value;  // longitude

    for(let i =0; i < markerPoint.length; i++){
      let lat = markerPoint[i].getPosition().lat();
      let lng = markerPoint[i].getPosition().lng();

      if((lat == latitude)&&(lng == longitude)){
        markerPoint[i].setMap(null);
        markerPoint.splice(i,1);
        return;
      }
    }
  }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap&libraries=places&language=ja" async defer>
</script> 
